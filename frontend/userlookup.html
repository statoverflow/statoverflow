<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Stat Overflow - User Lookup</title>
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="icomoon.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="desktop.css">

    <!-- HANDLEBARS TEMPLATES -->
    <script id="user_results_template" type="text/x-handlebars-template">
      <div id="user_search_result">
        <img id="user_search_img" src="{{profile_picture_url}}" />
        <div id="user_search_container1">
          <h2 id="user_search_username"><a href="{{user_url}}">{{username}}</a></h2>
          <p id="user_search_rep">Reputation: {{reputation_pts}}</p>
        </div>
        <div id="user_search_container2">
          <p id="user_search_date_reg">Date registered: {{date_reg}}</p>
          <p id="user_search_date_accessed">Last Accessed: {{date_last_access}}</p>
        </div>
      </div>
    </script>

    <script id="user_recent_questions_template" type="text/x-handlebars-template">
      <div class="recent_search">
        <span>{{question_title}}</span>
        <span>{{question_date}}</span>
        <a href="{{question_url}}">View</a>
      </div>
    </script>

    <style>
    #map {
      height: 500px;
      width: 100%;
    }
</style>
  </head>
  <body>
    <header>
      <div class="logo" id="logo_container">
        <img class="logo" src="./images/logo.svg" alt="stat overflow logo"/>
        <h1 class="logo">Stat Overflow</h1>
      </div>

      <nav>
        <a href="./index.html"><div id="questions_icon" class="icon-home"></div></a>
        <a href="./user.html"><div id="users_icon" class="icon-trophy"></div></a>
        <a href="./userlookup.html"><div id="userlookup_icon" class="icon-user"></div></a>
        <a href="./sitestats.html"><div id="stats_icon" class="icon-stats-bars"></div></a>
      </nav>
    </header>
    <main>
      <h1>Look up stack overflow user</h1>

      <form id="user_search_container">
        <label for="search_user">
          <input type="text" name="search_user" id="search_user" placeholder="Username" value="jon-skeet">
          <button name="search_user_button" id="search_user_button"><div class="icon-search"></div></button>
        </label>
      </form>

      <div id="user_search_result">
        <img id="user_search_img" src="http://placehold.it/100x100" />
        <div id="user_search_container1">
          <h2 id="user_search_username"><a href="index.html">Username</a></h2>
          <p id="user_search_rep">Reputation: #######</p>
        </div>
        <div id="user_search_container2">
          <p id="user_search_date_reg">Date registered: ##-##-####</p>
          <p id="user_search_date_accessed">Last Accessed: ##-##-####</p>
        </div>
      </div>

      <section id="user_search_recent">
        <h2>Recent Questions</h2>
        <div class="recent_search">
          <span>Question goes here.. hfhds s hds fsdhf hsdfhds hfsd </span>
          <span>##-##-####</span>
          <a href="#">View</a>
        </div>
        <div class="recent_search">
          <span>Question goes here.. hfhds s hds fsdhf hsdfhds hfsd </span>
          <span>##-##-####</span>
          <a href="#">View</a>
        </div>
        <div class="recent_search">
          <span>Question goes here.. hfhds s hds fsdhf hsdfhds hfsd </span>
          <span>##-##-####</span>
          <a href="#">View</a>
        </div>
        <div class="recent_search">
          <span>Question goes here.. hfhds s hds fsdhf hsdfhds hfsd </span>
          <span>##-##-####</span>
          <a href="#">View</a>
        </div>
        <div class="recent_search">
          <span>Question goes here.. hfhds s hds fsdhf hsdfhds hfsd </span>
          <span>##-##-####</span>
          <a href="#">View</a>
        </div>
      </section>

      <div id="user_search_map_container">
        <p id="user_search_map_location"><b>Location: </b> City, Country</p>
        <div id="map"></div>
      </div>

    </main>
    <footer>
      <nav>
        <a href="https://github.com/statoverflow"><div class="icon-github"></div></a>
      </nav>

      <p id="copyright_info">&copy; Stat Overflow development team (<a href="https://github.com/gricha2380">Gregor</a>, <a href="https://github.com/jpjazzy">Jeremy</a> and <a href="https://github.com/Jordanwvn">Jordan</a>)</p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
    <script src="app.js"></script>

    <script>
      $( document ).ready(function() {

      // globals
      let __API_URL__ = 'http://localhost:3000';
      // var locations = [];
      let locations = ['Bondi Beach', -33.890542, 151.274856, 4];

        // event listener for user search 
        document.querySelector('#search_user_button').addEventListener('click', function (e) {
          e.preventDefault();
          if (document.querySelector('#search_user').value !=='') {
            searchUsers();
          }
        });

      //ajax call for user search
      function searchUsers(){
        let username = document.querySelector('#search_user').value;
        console.log(`username: ${username}`);
        $.ajax({
          url: `${__API_URL__}/api/v1/user/`,
          method: 'GET',
          data: {
            search: username
          }
        }).done(function (data) {
          console.log('I recieved something', data);
          $('#user_search_result').empty();
          // locations = [];
          data.forEach((x, i) => {
            let box =
              `
                <div class="user_search_result">
                    <span class='count'>${i + 1}</span>
                    <img class="user_search_img" src="${x.user_image}" />
                    <div class="user_search_container1">
                      <h2 class="user_search_username"><a href="${x.link}">${x.user}</a></h2>
                      <p class="user_search_rep">Reputation: ${x.reputation}</p>
                    </div>
                    <div class="user_search_container2">
                      <p class="user_search_date_reg">Date registered: ${x.creation_date}</p>
                      <p class="user_search_date_accessed">Last Accessed: ${x.last_access_date}</p>
                      <p class="user_search_date_accessed">Location: ${x.location}</p>
                    </div>
                  </div>
              </div>
              `              
            $('#user_search_result').append(box);

          if (x.location!=="N/A") geocodeAddress(x.location);
            
          console.log(locations);
          mapRender();
          })
        }).fail(function (xhr, status, error) {
          console.error(error, xhr);
        });
      }
      searchUsers();

      // get lat long from text addresses
      function geocodeAddress(address1) {
        $.get('https://maps.googleapis.com/maps/api/geocode/json?address=' + address1 + '&key=AIzaSyAAHNPc_aDQ81b4sL2oLFa79vHn4LJ-s1w', function (data) {
          locations.push([address1, data['results'][0]['geometry']['location']['lat'], data['results'][0]['geometry']['location']['lng']]);
          mapRender();
        })
      }

      // map render
      function mapRender() {
        let bound = new google.maps.LatLngBounds();
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: new google.maps.LatLng(0, 0),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        // map.fitBounds(bound);
        // map.panToBounds(bound);
        var infowindow = new google.maps.InfoWindow();
        var marker, i;
        for (i = 0; i < locations.length; i++) {
          marker = new google.maps.Marker({
            position: new google.maps.LatLng(locations[i][1], locations[i][2]),
            map: map
          });
        }
        google.maps.event.addListener(marker, 'click', (function (marker, i) {
          return function () {
            infowindow.setContent(locations[i][0]);
            infowindow.open(map, marker);
          }
        })(marker, i));
      } //end map marker
      mapRender();

    }); // document ready
    </script>
  </body>
</html>
